<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Daoko – Where</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Leaflet (no key needed) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    :root { color-scheme: light dark; }
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 16px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: var(--tg-theme-bg-color, #fff);
      color: var(--tg-theme-text-color, #111);
      min-height: 100dvh; display: grid; place-items: center;
    }
    .card {
      width: 100%; max-width: 480px;
      padding: 16px; border-radius: 16px;
      background: var(--tg-theme-secondary-bg-color, #f5f5f5);
      box-shadow: 0 2px 10px rgba(0,0,0,.06);
    }
    h1 { margin: 0 0 8px; font-size: 20px; }
    .muted { opacity: .75; margin: 0 0 12px; }
    #map { width: 100%; height: 360px; border-radius: 12px; overflow: hidden; background: #dcdcdc; }
    .row { display: flex; gap: 8px; margin-top: 12px; }
    button {
      flex: 1; padding: 12px 14px; border: 0; border-radius: 12px;
      font-size: 16px; font-weight: 600;
      background: var(--tg-theme-button-color, #2ea6ff);
      color: var(--tg-theme-button-text-color, #fff);
      cursor: pointer;
    }
    button.secondary {
      background: transparent;
      color: var(--tg-theme-hint-color, #555);
      outline: 1px solid color-mix(in srgb, currentColor 25%, transparent);
    }
    .info {
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      font-size: 13px; margin-top: 10px; white-space: nowrap; overflow: auto;
    }
    .leaflet-control-attribution { font-size: 11px; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Set Where</h1>
    <p class="muted">Tap on the map (or drag the pin). Use “Send location” when ready.</p>

    <div id="map" role="application" aria-label="Location map"></div>

    <div class="info" id="coords">Lat: —, Lng: —</div>
    <div class="info" id="addr">Address: —</div>

    <div class="row">
      <button class="secondary" id="locate">Use my location</button>
      <button id="send">Send location</button>
    </div>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand?.();

    tg.MainButton.setText('Send location');
    tg.MainButton.hide();
    tg.MainButton.onClick(sendLocation);

    let map, marker, selected = null, layer, fallbackUsed = false;

    // 1) Init map
    map = L.map('map', { zoomControl: true, attributionControl: true })
            .setView([19.4326, -99.1332], 13); // CDMX default

    // 2) Add primary tiles (single host; fewer chances of being blocked)
    addTiles('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> contributors'
    });

    // 3) If the first tile fails, swap to a fallback provider automatically
    function addTiles(url, opts) {
      if (layer) map.removeLayer(layer);
      layer = L.tileLayer(url, opts).addTo(map);
      layer.once('tileerror', onTileError);
      // Helps after Telegram resizes/expands:
      setTimeout(() => map.invalidateSize(), 0);
    }

    function onTileError() {
      if (fallbackUsed) return;
      fallbackUsed = true;
      addTiles('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        subdomains: ['a','b','c','d'],
        maxZoom: 20,
        attribution: '&copy; OSM &copy; <a href="https://carto.com/attributions">CARTO</a>'
      });
    }

    // Click to place/move marker
    map.on('click', (e) => setMarker(e.latlng.lat, e.latlng.lng));

    document.getElementById('locate').addEventListener('click', () => {
      if (!navigator.geolocation) {
        alert('Geolocation not available. Tap the map to set a pin.');
        return;
      }
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const lat = pos.coords.latitude, lng = pos.coords.longitude;
          map.setView([lat, lng], 16);
          setMarker(lat, lng);
        },
        () => alert('Could not get location. Tap the map to set a pin.'),
        { enableHighAccuracy: true, timeout: 8000 }
      );
    });

    document.getElementById('send').addEventListener('click', sendLocation);

    function setMarker(lat, lng) {
      if (!marker) {
        marker = L.marker([lat, lng], { draggable: true }).addTo(map);
        marker.on('dragend', () => {
          const p = marker.getLatLng();
          updateSelection(p.lat, p.lng);
        });
      } else {
        marker.setLatLng([lat, lng]);
      }
      updateSelection(lat, lng);
      tg.MainButton.show();
    }

    function updateSelection(lat, lng) {
      selected = { lat: round6(lat), lng: round6(lng), address: null };
      document.getElementById('coords').textContent = `Lat: ${selected.lat}, Lng: ${selected.lng}`;
      document.getElementById('addr').textContent = 'Address: looking up…';
      reverseGeocode(lat, lng)
        .then(addr => {
          selected.address = addr || null;
          document.getElementById('addr').textContent = 'Address: ' + (addr || 'not available');
        })
        .catch(() => {
          selected.address = null;
          document.getElementById('addr').textContent = 'Address: not available';
        });
    }

    async function reverseGeocode(lat, lng) {
      const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`;
      const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
      if (!res.ok) return null;
      const data = await res.json();
      return data.display_name || null;
    }

    function sendLocation() {
      if (!selected) { alert('Please place the pin first.'); return; }
      tg.sendData(JSON.stringify({
        type: 'event_location',
        data: {
          lat: selected.lat,
          lng: selected.lng,
          address: selected.address ?? null
        }
      }));
      tg.close();
    }
    function round6(n) { return Math.round(n * 1e6) / 1e6; }
  </script>
</body>
</html>

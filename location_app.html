<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Daoko – Where</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root { color-scheme: light dark; }
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 16px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: var(--tg-theme-bg-color, #fff);
      color: var(--tg-theme-text-color, #111);
      min-height: 100dvh; display: grid; place-items: center;
    }
    .card {
      width: 100%; max-width: 480px;
      padding: 16px; border-radius: 16px;
      background: var(--tg-theme-secondary-bg-color, #f5f5f5);
      box-shadow: 0 2px 10px rgba(0,0,0,.06);
    }
    h1 { margin: 0 0 8px; font-size: 20px; }
    .muted { opacity: .75; margin: 0 0 12px; }
    #map {
      width: 100%; height: 360px;
      border-radius: 12px; overflow: hidden;
      background: #dcdcdc;
    }
    .row { display: flex; gap: 8px; margin-top: 12px; }
    button {
      flex: 1; padding: 12px 14px;
      border: 0; border-radius: 12px;
      font-size: 16px; font-weight: 600;
      background: var(--tg-theme-button-color, #2ea6ff);
      color: var(--tg-theme-button-text-color, #fff);
      cursor: pointer;
    }
    button.secondary {
      background: transparent;
      color: var(--tg-theme-hint-color, #555);
      outline: 1px solid color-mix(in srgb, currentColor 20%, transparent);
    }
    .info {
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      font-size: 13px; margin-top: 10px; white-space: nowrap; overflow: auto;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>Set Where</h1>
    <p class="muted">Tap on the map (or drag the pin). Use “Send location” when ready.</p>

    <div id="map" role="application" aria-label="Location map"></div>

    <div class="info" id="coords">Lat: —, Lng: —</div>
    <div class="info" id="addr">Address: —</div>

    <div class="row">
      <button class="secondary" id="locate">Use my location</button>
      <button id="send">Send location</button>
    </div>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand?.();

    // Show Telegram's native main button too (nice UX).
    tg.MainButton.setText('Send location');
    tg.MainButton.hide(); // hidden until a pin exists
    tg.MainButton.onClick(sendLocation);

    let map, marker, geocoder;
    let selected = null; // {lat, lng, address}

    function initMap() {
      geocoder = new google.maps.Geocoder();

      map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: 19.4326, lng: -99.1332 }, // CDMX default
        zoom: 13,
        mapTypeControl: false,
        fullscreenControl: false,
        streetViewControl: false,
      });

      map.addListener('click', (e) => setMarker(e.latLng));

      document.getElementById('locate').addEventListener('click', () => {
        if (!navigator.geolocation) {
          alert('Geolocation not available. Tap the map to set a pin.');
          return;
        }
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const ll = {
              lat: pos.coords.latitude,
              lng: pos.coords.longitude
            };
            map.panTo(ll);
            map.setZoom(16);
            setMarker(ll);
          },
          () => alert('Could not get location. Tap the map to set a pin.'),
          { enableHighAccuracy: true, timeout: 8000 }
        );
      });

      document.getElementById('send').addEventListener('click', sendLocation);
    }

    function setMarker(latLng) {
      if (!marker) {
        marker = new google.maps.Marker({
          position: latLng,
          map,
          draggable: true,
          animation: google.maps.Animation.DROP,
        });
        marker.addListener('dragend', () => {
          const p = marker.getPosition();
          updateSelection(p.lat(), p.lng());
        });
      } else {
        marker.setPosition(latLng);
      }
      updateSelection(
        latLng.lat ? latLng.lat() : latLng.lat,
        latLng.lng ? latLng.lng() : latLng.lng
      );
      tg.MainButton.show();
    }

    function updateSelection(lat, lng) {
      selected = { lat: round6(lat), lng: round6(lng), address: null };
      document.getElementById('coords').textContent =
        `Lat: ${selected.lat}, Lng: ${selected.lng}`;
      document.getElementById('addr').textContent = 'Address: looking up…';

      geocoder.geocode({ location: { lat, lng } }, (results, status) => {
        if (status === 'OK' && results && results[0]) {
          selected.address = results[0].formatted_address;
          document.getElementById('addr').textContent =
            'Address: ' + selected.address;
        } else {
          selected.address = null;
          document.getElementById('addr').textContent =
            'Address: not available';
        }
      });
    }

    function sendLocation() {
      if (!selected) {
        alert('Please place the pin first.');
        return;
      }
      const payload = {
        type: 'where',
        lat: selected.lat,
        lng: selected.lng,
        address: selected.address
      };

      // If opened from a reply keyboard, this sends data to your bot and closes.
      tg.sendData(JSON.stringify(payload));
      tg.close();
    }

    function round6(n) { return Math.round(n * 1e6) / 1e6; }

    // If the user switches Telegram theme while open, your CSS variables update automatically.
    // (No extra code needed beyond tg.ready()).

    // Google Maps loader
  </script>
  <script async
    src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&callback=initMap">
  </script>
</body>
</html>

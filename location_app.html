<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Create Event</title>

<!-- Telegram bridge -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<!-- Leaflet (no key) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>

<style>
  :root{
    /* ===== Blue dashboard palette (from SwiftUI) ===== */
    /* Background gradient stops */
    --bg-center: rgb(45,50,84);   /* elevated navy (file 234) */
    --bg-mid:    rgb(40,44,72);   /* slight mix for softness */
    --bg-edge:   rgb(33,36,65);   /* deep navy (file 233) */

    /* Text */
    --text: rgb(240,242,248);                 /* near-white for readability */
    --text-secondary: rgb(123,126,166);       /* asset textSecondary (file 235) */

    /* Surfaces */
    --surface: rgba(33,36,65,0.92);           /* backgroundElevated (file 233) */
    --surface-border: rgba(255,255,255,0.05); /* hairline */

    /* Accents */
    --accent-cyan:   rgb(89,123,246);   /* file 229 */
    --accent-green:  rgb(114,194,148);  /* file 230 */
    --accent-purple: rgb(78,53,190);    /* file 232 */

    /* Control/field fills */
    --field-bg: rgba(255,255,255,0.055);
    --field-stroke: rgba(255,255,255,0.12);
  }

  *{box-sizing:border-box}
  body{
    margin:0; padding:16px;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    color:var(--text);

    /* Blue radial base (no black overlay) */
    background-image:
      radial-gradient(circle at 80% 10%,
        var(--bg-center) 0%,
        var(--bg-mid) 45%,
        var(--bg-edge) 100%);
    background-attachment: fixed;
    background-size: cover;
  }

  .container{max-width:760px; margin:0 auto; display:grid; gap:18px; position:relative}

  /* Soft ambient glows (blue/purple) */
  .glow{position:fixed; pointer-events:none; z-index:0; filter:blur(70px); opacity:.32}
  .glow.blue{background:var(--accent-cyan); width:120px; height:120px; top:8vh; right:6vw}
  .glow.purple{background:var(--accent-purple); width:160px; height:160px; bottom:12vh; left:8vw}

  /* Cards: rounded, subtle border + deep shadow */
  .card{
    position:relative; z-index:1;
    background:var(--surface);
    border-radius:20px;
    padding:18px;
    border:1px solid var(--surface-border);
    box-shadow:
      0 8px 28px rgba(12,14,24,0.55),
      0 0 0 1px rgba(89,123,246,0.10); /* faint cyan rim */
  }

  /* Hero */
  .hero{padding:22px; display:grid; gap:6px}
  .hero h1{margin:0; font-size:18px; font-weight:700; letter-spacing:.2px}
  .hero p{margin:0; color:var(--text-secondary)}

  /* Section headers */
  .section-title{display:flex; align-items:center; gap:12px; margin-bottom:16px; font-weight:600}
  .bullet{
    width:36px; height:36px; border-radius:12px; color:#fff; display:grid; place-items:center; font-size:16px;
    background:
      radial-gradient(120% 120% at 25% 20%, rgba(114,194,148,1) 0%, rgba(89,123,246,1) 70%, rgba(78,53,190,1) 100%);
    box-shadow:
      0 2px 10px rgba(0,0,0,.35),
      0 0 0 1px rgba(255,255,255,.07) inset;
  }

  /* Fields */
  .field{display:grid; gap:8px; margin-top:12px}
  .label{font-size:13px; color:var(--text); opacity:.95; display:flex; align-items:center; gap:8px}
  .label .tick{width:6px; height:16px; border-radius:2px; background:rgba(255,255,255,.10); display:inline-block}
  input[type="text"], input[type="datetime-local"], input[type="search"]{
    height:44px; border-radius:12px; padding:0 14px;
    background:var(--field-bg);
    color:var(--text);
    border:1px solid var(--field-stroke);
    outline:none; caret-color:var(--accent-cyan); accent-color:var(--accent-cyan);
    box-shadow:inset 0 -1px 0 rgba(255,255,255,.04);
  }
  input::placeholder{color:color-mix(in srgb, var(--text-secondary) 75%, transparent)}
  .search-row{display:grid; grid-template-columns:1fr auto; gap:8px}
  .icon-btn{
    min-width:44px; height:44px; border-radius:12px; cursor:pointer;
    background:var(--field-bg); color:var(--text);
    border:1px solid var(--field-stroke);
    box-shadow:inset 0 0 0 1px rgba(255,255,255,.02);
  }

  /* Map section */
  .map-wrap{position:relative; height:360px; margin-top:8px}
  #map{position:absolute; inset:0; border-radius:16px; overflow:hidden; background: #dcdcdc;}
  .controls{
    position:absolute; top:10px; right:10px; z-index:10;
    display:flex; flex-direction:column; gap:8px
  }
  .control-btn{
    width:40px; height:40px; border-radius:12px; cursor:pointer;
    background:var(--field-bg); color:var(--text);
    border:1px solid var(--field-stroke);
    display:grid; place-items:center;
  }
  .badge{
    position:absolute; left:10px; bottom:10px; z-index:10;
    font-size:12px; border-radius:999px; padding:5px 10px;
    background:rgba(27,30,50,.75);
    border:1px solid rgba(255,255,255,.10);
    color:var(--text);
    backdrop-filter:blur(6px)
  }

  /* Info + actions */
  .meta{display:grid; gap:6px; margin-top:10px}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace; font-size:12px; color:var(--text-secondary)}
  .actions{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  .btn{
    height:46px; border-radius:12px; font-weight:600; cursor:pointer; border:0;
    background:var(--accent-cyan); color:#fff;
    box-shadow:
      0 12px 28px rgba(10,14,30,0.45),
      0 0 0 1px rgba(255,255,255,.06) inset;
  }
  .btn.secondary{
    background:transparent; color:var(--text);
    border:1px solid color-mix(in srgb, var(--accent-cyan) 55%, transparent);
  }
  .btn:disabled{opacity:.6; cursor:not-allowed}
  .error{color:rgb(227,93,104); font-size:12px; display:none} /* file 231 */
  .leaflet-control-attribution{font-size:11px}
  .ico{font:16px/1 system-ui,sans-serif}
</style>
</head>
<body>
  <!-- ambient glows -->
  <div class="glow blue"></div>
  <div class="glow purple"></div>

  <div class="container">
    <!-- HERO -->
    <div class="card hero">
      <h1>Create Event</h1>
      <p>Elite combat sport event setup</p>
    </div>

    <!-- EVENT DETAILS -->
    <div class="card">
      <div class="section-title"><div class="bullet">üí°</div><div>Event Details</div></div>

      <div class="field">
        <div class="label"><span class="tick"></span>Event Name</div>
        <input id="eventName" type="text" placeholder="e.g., Championship Arena" autocomplete="off" />
      </div>

      <div class="field">
        <div class="label"><span class="tick"></span>Event Date</div>
        <input id="eventDate" type="datetime-local" />
        <div id="dateError" class="error">Please choose a date &amp; time.</div>
      </div>
    </div>

    <!-- EVENT LOCATION -->
    <div class="card">
      <div class="section-title"><div class="bullet">üìç</div><div>Event Location</div></div>

      <div class="field">
        <div class="label"><span class="tick"></span>Search Arena</div>
        <div class="search-row">
          <input id="searchInput" type="search" placeholder="Find elite venues..." />
          <button id="searchBtn" class="icon-btn" title="Search"><span class="ico">üîç</span></button>
        </div>
      </div>

      <div class="field">
        <div class="label"><span class="tick"></span>Tactical Map</div>
        <div class="map-wrap">
          <div id="map" role="application" aria-label="Location map"></div>
          <div class="controls">
            <button class="control-btn" id="zoomIn" title="Zoom in"><span class="ico">Ôºã</span></button>
            <button class="control-btn" id="zoomOut" title="Zoom out"><span class="ico">Ôºç</span></button>
            <button class="control-btn" id="locate" title="Use my location"><span class="ico">‚óé</span></button>
          </div>
          <div class="badge" id="zoomBadge">Zoom: ‚Äî</div>
        </div>
        <div id="locError" class="error">Please place the pin.</div>

        <div class="meta">
          <div class="mono" id="coords">Lat: ‚Äî, Lng: ‚Äî</div>
          <div class="mono" id="addr">Address: ‚Äî</div>
        </div>
      </div>

      <div class="actions" style="margin-top:12px">
        <button class="btn secondary" id="useMyLocation" type="button">Use my location</button>
        <button class="btn" id="createBtn" type="button">Create event</button>
      </div>
    </div>
  </div>

<script>
  // Telegram bridge
  const tg = window.Telegram.WebApp; tg.ready(); tg.expand?.();

  // === ADDED: read startapp payload (ctx) ===
  const startParam =
    (tg.initDataUnsafe && tg.initDataUnsafe.start_param) ||
    new URLSearchParams(location.search).get('tgWebAppStartParam') ||
    new URLSearchParams(location.search).get('ctx') ||
    '';

  // Elements
  const nameInput = document.getElementById('eventName');
  const dateInput = document.getElementById('eventDate');
  const searchInput = document.getElementById('searchInput');
  const searchBtn   = document.getElementById('searchBtn');
  const createBtn   = document.getElementById('createBtn');
  const dateError   = document.getElementById('dateError');
  const locError    = document.getElementById('locError');

  // Prefill date (next 15m)
  (function prefill() {
    const now = new Date(); now.setSeconds(0,0);
    const m = now.getMinutes(); now.setMinutes(m + (15 - (m % 15)) % 15);
    dateInput.value = toLocalDatetimeValue(now);
  })();

  // Map setup (unchanged)
  let map, marker, selected = null;
  map = L.map('map', { zoomControl: false, attributionControl: true })
          .setView([19.4326, -99.1332], 13);
  setTimeout(() => map.invalidateSize(), 0);

  const light = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
    subdomains: ['a','b','c','d'],
    maxZoom: 20,
    attribution: '&copy; OSM &copy; <a href="https://carto.com/attributions">CARTO</a>'
  }).addTo(map);
  light.once('tileerror', () => {
      L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> contributors'
      }).addTo(map);
    });

  map.on('click', (e) => setMarker(e.latlng.lat, e.latlng.lng));
  map.on('zoomend', () => document.getElementById('zoomBadge').textContent = `Zoom: ${map.getZoom()}`);

  document.getElementById('zoomIn').onclick  = () => map.zoomIn();
  document.getElementById('zoomOut').onclick = () => map.zoomOut();
  document.getElementById('locate').onclick  = useMyLocation;
  document.getElementById('useMyLocation').onclick = useMyLocation;

  searchBtn.onclick = searchVenue;
  searchInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') searchVenue(); });

  async function searchVenue() {
    const q = searchInput.value.trim();
    if (!q) return;
    try {
      const url = `https://nominatim.openstreetmap.org/search?format=jsonv2&q=${encodeURIComponent(q)}&limit=1`;
      const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
      const data = await res.json();
      if (Array.isArray(data) && data.length) {
        const lat = parseFloat(data[0].lat), lng = parseFloat(data[0].lon);
        map.setView([lat, lng], 16);
        setMarker(lat, lng, data[0].display_name);
      }
    } catch {}
  }

  function useMyLocation() {
    if (!navigator.geolocation) return alert('Geolocation not available.');
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const lat = pos.coords.latitude, lng = pos.coords.longitude;
        map.setView([lat, lng], 16);
        setMarker(lat, lng);
      },
      () => alert('Could not get location. Tap the map to set a pin.'),
      { enableHighAccuracy: true, timeout: 8000 }
    );
  }

  function setMarker(lat, lng, presetAddress) {
    if (!marker) {
      marker = L.marker([lat, lng], { draggable: true }).addTo(map);
      marker.on('dragend', () => {
        const p = marker.getLatLng();
        updateSelection(p.lat, p.lng);
      });
    } else {
      marker.setLatLng([lat, lng]);
    }
    updateSelection(lat, lng, presetAddress);
  }

  function updateSelection(lat, lng, presetAddress) {
    selected = { lat: round6(lat), lng: round6(lng), address: null };
    document.getElementById('coords').textContent = `Lat: ${selected.lat}, Lng: ${selected.lng}`;
    document.getElementById('addr').textContent = 'Address: looking up‚Ä¶';

    if (presetAddress) {
      selected.address = presetAddress;
      document.getElementById('addr').textContent = 'Address: ' + presetAddress;
      updateValidity();
      return;
    }

    reverseGeocode(lat, lng).then(addr => {
      selected.address = addr || null;
      document.getElementById('addr').textContent = 'Address: ' + (addr || 'not available');
      updateValidity();
    }).catch(() => {
      selected.address = null;
      document.getElementById('addr').textContent = 'Address: not available';
      updateValidity();
    });
  }

  async function reverseGeocode(lat, lng) {
    const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`;
    const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
    if (!res.ok) return null;
    const data = await res.json();
    return data.display_name || null;
  }

  // Validation + MainButton
  nameInput.addEventListener('input', updateValidity);
  dateInput.addEventListener('input', updateValidity);
  createBtn.addEventListener('click', send);

  tg.MainButton.setText('Create event');
  tg.MainButton.onClick(send);
  updateValidity();

  function updateValidity() {
    const ok = isValid();
    dateError.style.display = dateInput.value ? 'none' : 'block';
    locError.style.display  = selected ? 'none' : 'block';
    createBtn.disabled = !ok;
    if (ok) tg.MainButton.show(); else tg.MainButton.hide();
  }

  function isValid() {
    return nameInput.value.trim().length > 0 && !!dateInput.value && !!selected;
  }

  function send() {
    if (!isValid()) return;
    const whenLocal = dateInput.value;
    const whenISO = toIsoFromLocal(whenLocal);
    const payload = {
      type: 'create_event',
      // === ADDED: echo startapp payload back ===
      ctx: startParam,
      data: {
        name: nameInput.value.trim(),
        datetime_local: whenLocal,
        datetime_iso: whenISO,
        tz_offset_minutes: new Date().getTimezoneOffset() * -1,
        location: { lat: selected.lat, lng: selected.lng, address: selected.address ?? null }
      }
    };
    tg.sendData(JSON.stringify(payload));
    tg.close();
  }

  // Helpers
  function round6(n){ return Math.round(n*1e6)/1e6; }
  function toLocalDatetimeValue(d){
    const p = n => String(n).padStart(2,'0');
    return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}T${p(d.getHours())}:${p(d.getMinutes())}`;
  }
  function toIsoFromLocal(localStr){
    if(!localStr) return null;
    const [date,time]=localStr.split('T'); const [y,m,dd]=date.split('-').map(Number);
    const [hh,mm]=(time||'00:00').split(':').map(Number);
    return new Date(y,m-1,dd,hh,mm,0).toISOString();
  }
</script>
</body>
</html>

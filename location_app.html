<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Create Event</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Leaflet (no key needed) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    :root { color-scheme: light dark; }
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 16px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: var(--tg-theme-bg-color, #fff);
      color: var(--tg-theme-text-color, #111);
      min-height: 100dvh; display: grid; place-items: center;
    }
    .card {
      width: 100%; max-width: 520px;
      padding: 16px; border-radius: 16px;
      background: var(--tg-theme-secondary-bg-color, #f5f5f5);
      box-shadow: 0 2px 10px rgba(0,0,0,.06);
    }
    h1 { margin: 0 0 12px; font-size: 20px; }
    .muted { opacity: .8; margin: 0 0 16px; }
    .field { display: grid; gap: 6px; margin: 12px 0; }
    .label { font-size: 13px; opacity: .9; }
    input[type="text"], input[type="datetime-local"], input[type="date"] {
      width: 100%; padding: 12px 14px; border-radius: 12px;
      border: 1px solid color-mix(in srgb, currentColor 20%, transparent);
      background: var(--tg-theme-bg-color, #fff);
      color: var(--tg-theme-text-color, #111);
      outline: none;
    }
    #map {
      width: 100%; height: 360px; border-radius: 12px; overflow: hidden;
      background: #dcdcdc; margin-top: 8px;
    }
    .row { display: flex; gap: 8px; margin-top: 12px; }
    button {
      flex: 1; padding: 12px 14px; border: 0; border-radius: 12px;
      font-size: 16px; font-weight: 600;
      background: var(--tg-theme-button-color, #2ea6ff);
      color: var(--tg-theme-button-text-color, #fff);
      cursor: pointer;
    }
    button.secondary {
      background: transparent;
      color: var(--tg-theme-hint-color, #555);
      outline: 1px solid color-mix(in srgb, currentColor 25%, transparent);
    }
    .info {
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      font-size: 12px; margin-top: 8px; white-space: nowrap; overflow: auto;
    }
    .error { color: #b00020; font-size: 12px; margin-top: 6px; display: none; }
    .leaflet-control-attribution { font-size: 11px; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Create Event</h1>
    <p class="muted">Fill the details and pick a location. The form will send a single payload to your bot.</p>

    <!-- Event name -->
    <div class="field">
      <label class="label" for="eventName">Event name</label>
      <input id="eventName" type="text" placeholder="E.g. Training at La Merced" autocomplete="off" />
    </div>

    <!-- Event date/time (uses datetime-local; you can switch to date only if you prefer) -->
    <div class="field">
      <label class="label" for="eventDate">Date & time</label>
      <input id="eventDate" type="datetime-local" />
      <div id="dateError" class="error">Please choose a date/time.</div>
    </div>

    <!-- Map -->
    <div class="field">
      <label class="label">Location</label>
      <div id="map" role="application" aria-label="Location map"></div>
      <div class="info" id="coords">Lat: —, Lng: —</div>
      <div class="info" id="addr">Address: —</div>
      <div id="locError" class="error">Please place the pin.</div>
    </div>

    <div class="row">
      <button class="secondary" id="locate" type="button">Use my location</button>
      <button id="send" type="button">Create event</button>
    </div>
  </div>

  <script>
    // Telegram bridge
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand?.();

    // MainButton mirrors the in-page button
    tg.MainButton.setText('Create event');
    tg.MainButton.hide();
    tg.MainButton.onClick(sendEvent);

    // State
    let map, marker, selected = null, layer, fallbackUsed = false;

    // Prefill event date with "now" rounded to next 15m
    (function prefillDate() {
      const input = document.getElementById('eventDate');
      const now = new Date();
      now.setSeconds(0,0);
      const mins = now.getMinutes();
      now.setMinutes(mins + (15 - (mins % 15)) % 15);
      input.value = toLocalDatetimeValue(now);
    })();

    // Validate form: show/hide TG MainButton
    const nameInput = document.getElementById('eventName');
    const dateInput = document.getElementById('eventDate');
    nameInput.addEventListener('input', updateValidity);
    dateInput.addEventListener('input', updateValidity);

    function updateValidity() {
      const ok = isValid();
      document.getElementById('dateError').style.display = dateInput.value ? 'none' : 'block';
      document.getElementById('locError').style.display = selected ? 'none' : 'block';
      if (ok) tg.MainButton.show(); else tg.MainButton.hide();
      document.getElementById('send').disabled = !ok;
    }

    function isValid() {
      return nameInput.value.trim().length > 0
          && dateInput.value
          && !!selected;
    }

    // Map init (Leaflet)
    map = L.map('map', { zoomControl: true, attributionControl: true })
            .setView([19.4326, -99.1332], 13); // CDMX default

    addTiles('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> contributors'
    });

    function addTiles(url, opts) {
      if (layer) map.removeLayer(layer);
      layer = L.tileLayer(url, opts).addTo(map);
      layer.once('tileerror', onTileError);
      setTimeout(() => map.invalidateSize(), 0);
    }

    function onTileError() {
      if (fallbackUsed) return;
      fallbackUsed = true;
      addTiles('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        subdomains: ['a','b','c','d'],
        maxZoom: 20,
        attribution: '&copy; OSM &copy; <a href="https://carto.com/attributions">CARTO</a>'
      });
    }

    // Map interactions
    map.on('click', (e) => setMarker(e.latlng.lat, e.latlng.lng));

    document.getElementById('locate').addEventListener('click', () => {
      if (!navigator.geolocation) {
        alert('Geolocation not available. Tap the map to set a pin.');
        return;
      }
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const lat = pos.coords.latitude, lng = pos.coords.longitude;
          map.setView([lat, lng], 16);
          setMarker(lat, lng);
        },
        () => alert('Could not get location. Tap the map to set a pin.'),
        { enableHighAccuracy: true, timeout: 8000 }
      );
    });

    document.getElementById('send').addEventListener('click', sendEvent);

    function setMarker(lat, lng) {
      if (!marker) {
        marker = L.marker([lat, lng], { draggable: true }).addTo(map);
        marker.on('dragend', () => {
          const p = marker.getLatLng();
          updateSelection(p.lat, p.lng);
        });
      } else {
        marker.setLatLng([lat, lng]);
      }
      updateSelection(lat, lng);
    }

    function updateSelection(lat, lng) {
      selected = { lat: round6(lat), lng: round6(lng), address: null };
      document.getElementById('coords').textContent = `Lat: ${selected.lat}, Lng: ${selected.lng}`;
      document.getElementById('addr').textContent = 'Address: looking up…';
      reverseGeocode(lat, lng)
        .then(addr => {
          selected.address = addr || null;
          document.getElementById('addr').textContent = 'Address: ' + (addr || 'not available');
          updateValidity();
        })
        .catch(() => {
          selected.address = null;
          document.getElementById('addr').textContent = 'Address: not available';
          updateValidity();
        });
    }

    async function reverseGeocode(lat, lng) {
      const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`;
      const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
      if (!res.ok) return null;
      const data = await res.json();
      return data.display_name || null;
    }

    // Sender
    function sendEvent() {
      // show inline validation
      updateValidity();
      if (!isValid()) return;

      // build event object
      const whenLocal = dateInput.value; // "YYYY-MM-DDTHH:MM"
      const whenISO = toIsoFromLocal(whenLocal); // standardized
      const payload = {
        type: 'create_event',
        data: {
          name: nameInput.value.trim(),
          datetime_local: whenLocal,
          datetime_iso: whenISO,
          tz_offset_minutes: new Date().getTimezoneOffset() * -1, // positive east
          location: {
            lat: selected.lat,
            lng: selected.lng,
            address: selected.address ?? null
          }
        }
      };

      tg.sendData(JSON.stringify(payload));
      tg.close();
    }

    // helpers
    function round6(n) { return Math.round(n * 1e6) / 1e6; }
    function toLocalDatetimeValue(d) {
      // returns "YYYY-MM-DDTHH:MM" in local time
      const pad = (n) => String(n).padStart(2,'0');
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }
    function toIsoFromLocal(localStr) {
      // interpret local "YYYY-MM-DDTHH:MM" as local time and convert to ISO
      if (!localStr) return null;
      const [date, time] = localStr.split('T');
      const [y,m,dd] = date.split('-').map(Number);
      const [hh,mm] = (time || '00:00').split(':').map(Number);
      const dt = new Date(y, (m-1), dd, hh, mm, 0);
      return dt.toISOString();
    }
  </script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Create Event</title>

<!-- Telegram bridge -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<!-- Leaflet (no key) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>

<style>
  /* ‚Ä¶ (unchanged CSS) ‚Ä¶ */
</style>
</head>
<body>
  <!-- ambient glows -->
  <div class="glow blue"></div>
  <div class="glow purple"></div>

  <div class="container">
    <!-- HERO -->
    <div class="card hero">
      <h1>Create Event</h1>
      <p>Elite combat sport event setup</p>
    </div>

    <!-- EVENT DETAILS -->
    <div class="card">
      <div class="section-title"><div class="bullet">üí°</div><div>Event Details</div></div>

      <div class="field">
        <div class="label"><span class="tick"></span>Event Name</div>
        <input id="eventName" type="text" placeholder="e.g., Championship Arena" autocomplete="off" />
      </div>

      <div class="field">
        <div class="label"><span class="tick"></span>Event Date</div>
        <input id="eventDate" type="datetime-local" />
        <div id="dateError" class="error">Please choose a date &amp; time.</div>
      </div>
    </div>

    <!-- EVENT LOCATION -->
    <div class="card">
      <div class="section-title"><div class="bullet">üìç</div><div>Event Location</div></div>

      <div class="field">
        <div class="label"><span class="tick"></span>Search Arena</div>
        <div class="search-row">
          <input id="searchInput" type="search" placeholder="Find elite venues..." />
          <button id="searchBtn" class="icon-btn" title="Search"><span class="ico">üîç</span></button>
        </div>
      </div>

      <div class="field">
        <div class="label"><span class="tick"></span>Tactical Map</div>
        <div class="map-wrap">
          <div id="map" role="application" aria-label="Location map"></div>
          <div class="controls">
            <button class="control-btn" id="zoomIn" title="Zoom in"><span class="ico">Ôºã</span></button>
            <button class="control-btn" id="zoomOut" title="Zoom out"><span class="ico">Ôºç</span></button>
            <button class="control-btn" id="locate" title="Use my location"><span class="ico">‚óé</span></button>
          </div>
          <div class="badge" id="zoomBadge">Zoom: ‚Äî</div>
        </div>
        <div id="locError" class="error">Please place the pin.</div>

        <div class="meta">
          <div class="mono" id="coords">Lat: ‚Äî, Lng: ‚Äî</div>
          <div class="mono" id="addr">Address: ‚Äî</div>
        </div>
      </div>

      <div class="actions" style="margin-top:12px">
        <button class="btn secondary" id="useMyLocation" type="button">Use my location</button>
        <button class="btn" id="createBtn" type="button">Create event</button>
      </div>
    </div>
  </div>

<script>
  // Telegram bridge
  const tg = window.Telegram.WebApp; tg.ready(); tg.expand?.();

  // === ADDED: read startapp payload (ctx) ===
  const startParam =
    (tg.initDataUnsafe && tg.initDataUnsafe.start_param) ||
    new URLSearchParams(location.search).get('tgWebAppStartParam') ||
    '';

  // Elements
  const nameInput = document.getElementById('eventName');
  const dateInput = document.getElementById('eventDate');
  const searchInput = document.getElementById('searchInput');
  const searchBtn   = document.getElementById('searchBtn');
  const createBtn   = document.getElementById('createBtn');
  const dateError   = document.getElementById('dateError');
  const locError    = document.getElementById('locError');

  // Prefill date (next 15m)
  (function prefill() {
    const now = new Date(); now.setSeconds(0,0);
    const m = now.getMinutes(); now.setMinutes(m + (15 - (m % 15)) % 15);
    dateInput.value = toLocalDatetimeValue(now);
  })();

  // Map setup ‚Ä¶
  let map, marker, selected = null;
  map = L.map('map', { zoomControl: false, attributionControl: true })
          .setView([19.4326, -99.1332], 13);
  setTimeout(() => map.invalidateSize(), 0);

  const light = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
    subdomains: ['a','b','c','d'],
    maxZoom: 20,
    attribution: '&copy; OSM &copy; <a href="https://carto.com/attributions">CARTO</a>'
  }).addTo(map);
  light.once('tileerror', () => {
      L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> contributors'
      }).addTo(map);
    });

  map.on('click', (e) => setMarker(e.latlng.lat, e.latlng.lng));
  map.on('zoomend', () => document.getElementById('zoomBadge').textContent = `Zoom: ${map.getZoom()}`);

  document.getElementById('zoomIn').onclick  = () => map.zoomIn();
  document.getElementById('zoomOut').onclick = () => map.zoomOut();
  document.getElementById('locate').onclick  = useMyLocation;
  document.getElementById('useMyLocation').onclick = useMyLocation;

  searchBtn.onclick = searchVenue;
  searchInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') searchVenue(); });

  async function searchVenue() {
    const q = searchInput.value.trim();
    if (!q) return;
    try {
      const url = `https://nominatim.openstreetmap.org/search?format=jsonv2&q=${encodeURIComponent(q)}&limit=1`;
      const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
      const data = await res.json();
      if (Array.isArray(data) && data.length) {
        const lat = parseFloat(data[0].lat), lng = parseFloat(data[0].lon);
        map.setView([lat, lng], 16);
        setMarker(lat, lng, data[0].display_name);
      }
    } catch {}
  }

  function useMyLocation() {
    if (!navigator.geolocation) return alert('Geolocation not available.');
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const lat = pos.coords.latitude, lng = pos.coords.longitude;
        map.setView([lat, lng], 16);
        setMarker(lat, lng);
      },
      () => alert('Could not get location. Tap the map to set a pin.'),
      { enableHighAccuracy: true, timeout: 8000 }
    );
  }

  function setMarker(lat, lng, presetAddress) {
    if (!marker) {
      marker = L.marker([lat, lng], { draggable: true }).addTo(map);
      marker.on('dragend', () => {
        const p = marker.getLatLng();
        updateSelection(p.lat, p.lng);
      });
    } else {
      marker.setLatLng([lat, lng]);
    }
    updateSelection(lat, lng, presetAddress);
  }

  function updateSelection(lat, lng, presetAddress) {
    selected = { lat: round6(lat), lng: round6(lng), address: null };
    document.getElementById('coords').textContent = `Lat: ${selected.lat}, Lng: ${selected.lng}`;
    document.getElementById('addr').textContent = 'Address: looking up‚Ä¶';

    if (presetAddress) {
      selected.address = presetAddress;
      document.getElementById('addr').textContent = 'Address: ' + presetAddress;
      updateValidity();
      return;
    }

    reverseGeocode(lat, lng).then(addr => {
      selected.address = addr || null;
      document.getElementById('addr').textContent = 'Address: ' + (addr || 'not available');
      updateValidity();
    }).catch(() => {
      selected.address = null;
      document.getElementById('addr').textContent = 'Address: not available';
      updateValidity();
    });
  }

  async function reverseGeocode(lat, lng) {
    const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`;
    const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
    if (!res.ok) return null;
    const data = await res.json();
    return data.display_name || null;
  }

  // Validation + MainButton
  nameInput.addEventListener('input', updateValidity);
  dateInput.addEventListener('input', updateValidity);
  createBtn.addEventListener('click', send);

  tg.MainButton.setText('Create event');
  tg.MainButton.onClick(send);
  updateValidity();

  function updateValidity() {
    const ok = isValid();
    dateError.style.display = dateInput.value ? 'none' : 'block';
    locError.style.display  = selected ? 'none' : 'block';
    createBtn.disabled = !ok;
    if (ok) tg.MainButton.show(); else tg.MainButton.hide();
  }

  function isValid() {
    return nameInput.value.trim().length > 0 && !!dateInput.value && !!selected;
  }

  function send() {
    if (!isValid()) return;
    const whenLocal = dateInput.value;
    const whenISO = toIsoFromLocal(whenLocal);
    const payload = {
      type: 'create_event',
      // === ADDED: echo startapp payload back ===
      ctx: startParam,
      data: {
        name: nameInput.value.trim(),
        datetime_local: whenLocal,
        datetime_iso: whenISO,
        tz_offset_minutes: new Date().getTimezoneOffset() * -1,
        location: { lat: selected.lat, lng: selected.lng, address: selected.address ?? null }
      }
    };
    tg.sendData(JSON.stringify(payload));
    tg.close();
  }

  // Helpers
  function round6(n){ return Math.round(n*1e6)/1e6; }
  function toLocalDatetimeValue(d){
    const p = n => String(n).padStart(2,'0');
    return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}T${p(d.getHours())}:${p(d.getMinutes())}`;
  }
  function toIsoFromLocal(localStr){
    if(!localStr) return null;
    const [date,time]=localStr.split('T'); const [y,m,dd]=date.split('-').map(Number);
    const [hh,mm]=(time||'00:00').split(':').map(Number);
    return new Date(y,m-1,dd,hh,mm,0).toISOString();
  }
</script>
</body>
</html>
